{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Obere Reihe für Scanner und gescannte Items -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h4>1. Raum scannen oder eingeben</h4>
            <div class="form-group mb-3">
                <input type="text" class="form-control form-control-lg" id="raumfeld" placeholder="Raum-QR-Code scannen...">
            </div>
            <h4>2. Geräte scannen</h4>
            <div id="reader" style="width: 100%; max-width: 600px; margin: auto; border: 1px solid lightgray;"></div>
            <div class="controls mt-3">
                <button class="btn btn-info start">Kamera Start</button>
                <button class="btn btn-danger stop">Kamera Stop</button>
                <button class="btn btn-outline-info" id="torch-btn" style="display: none;">Blitz</button>
                <button class="btn btn-warning reset float-end">Reset</button>
            </div>
        </div>
        <div class="col-md-6">
            <h4>Gescannte Geräte</h4>
            <div id="result_strip" class="mb-3" style="max-height: 250px; overflow-y: auto;">
                <ul class="thumbnails list-group"></ul>
            </div>
             <div class="d-grid">
                <button id="start-import-btn" class="btn btn-success btn-lg">Import nach TopDesk starten</button>
            </div>
            <!-- Dieses Feedback-Feld wird jetzt nicht mehr direkt verwendet -->
            <div id="import-feedback" class="mt-2"></div>
        </div>
    </div>

    <!-- Untere Reihe für die Asset-Checkliste -->
    <hr>
    <h4>Asset-Checkliste für den ausgewählten Raum</h4>
    <div id="checklist-container" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-sm table-bordered">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>ID</th>
                    <th>Beschreibung</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="asset-checklist-body">
                <tr>
                    <td colspan="3" class="text-center text-muted">Bitte zuerst einen Raum auswählen.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal für die Import-Bestätigung -->
<div class="modal fade" id="importConfirmModal" tabindex="-1" aria-labelledby="importConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importConfirmModalLabel">Bestätigung erforderlich</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Es fehlen <strong id="missing-assets-count"></strong> Assets aus der Checkliste.</p>
        <p>Wie möchten Sie fortfahren?</p>
        <ul id="missing-assets-list" class="list-group mb-3" style="max-height: 150px; overflow-y: auto;">
            <!-- Fehlende Assets werden hier eingefügt -->
        </ul>
        <div class="d-grid gap-2">
            <button type="button" id="import-update-only-btn" class="btn btn-primary">Nur gefundene Assets aktualisieren</button>
            <button type="button" id="import-remove-missing-btn" class="btn btn-danger">Fehlende Assets aus Raum entfernen & aktualisieren</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Skripte am Ende der Datei -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(function() {
    const App = {
        raum: "",
        scannedItems: [],
        checklist: [],
        missingAssets: [],
        scannerState: null,
        importConfirmModal: new bootstrap.Modal(document.getElementById('importConfirmModal')),
        audioContext: null,
        videoTrack: null,
        torchOn: false
    };

    function playBeep() {
        try {
            if (!App.audioContext) App.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = App.audioContext.createOscillator();
            const gainNode = App.audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(App.audioContext.destination);
            gainNode.gain.setValueAtTime(0, App.audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(1, App.audioContext.currentTime + 0.01);
            oscillator.frequency.setValueAtTime(880, App.audioContext.currentTime);
            oscillator.type = 'square';
            oscillator.start(App.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, App.audioContext.currentTime + 0.1);
            oscillator.stop(App.audioContext.currentTime + 0.1);
        } catch(e) { console.error("Beep konnte nicht abgespielt werden:", e); }
    }

    function renderScannedItems() {
        const $list = $(".thumbnails");
        $list.empty();
        if (App.scannedItems.length === 0) {
            $list.append('<li class="list-group-item text-muted">Noch keine Geräte gescannt.</li>');
            return;
        }
        App.scannedItems.forEach(code => {
            let $li = $(`<li class="list-group-item d-flex justify-content-between align-items-center"><span>${code}</span><button type="button" class="btn btn-outline-danger btn-sm" onclick="removeScan('${code}')">&times;</button></li>`);
            $list.prepend($li);
        });
    }

    function renderChecklistTable() {
        const $tableBody = $("#asset-checklist-body");
        const $feedback = $("#import-feedback");
        $tableBody.empty();
        $feedback.empty().hide();
        if (App.checklist.length === 0) {
            $tableBody.append('<tr><td colspan="3" class="text-center text-muted">Für diesen Raum sind keine Assets in TopDesk hinterlegt.</td></tr>');
            return;
        }
        let foundCount = 0;
        App.checklist.forEach(asset => {
            const inventoryNumber = asset?.name || 'N/A';
            const description = asset['@@summary'] || 'N/A';
            const isScanned = App.scannedItems.includes(inventoryNumber);
            if (isScanned) foundCount++;
            const rowClass = isScanned ? 'table-success' : 'table-danger';
            const rowHtml = `<tr class="${rowClass}"><td>${inventoryNumber}</td><td>${description}</td><td>${isScanned ? 'Gefunden ✔' : 'Fehlt ✖'}</td></tr>`;
            $tableBody.append(rowHtml);
        });
        if (App.checklist.length > 0 && foundCount === App.checklist.length) {
            $feedback.removeClass().addClass('alert alert-success').text('Alle Assets in der Checkliste gefunden!').show();
        }
    }

    function addScannedItem(code) {
        if (code && !App.scannedItems.includes(code)) {
            App.scannedItems.push(code);
            renderScannedItems();
            renderChecklistTable();
        }
    }

    window.removeScan = function(code) {
        App.scannedItems = App.scannedItems.filter(item => item !== code);
        renderScannedItems();
        renderChecklistTable();
    };

    function fetchChecklist(roomName) {
        if (!roomName) {
            App.checklist = [];
            $("#asset-checklist-body").html('<tr><td colspan="3" class="text-center text-muted">Bitte zuerst einen Raum auswählen.</td></tr>');
            return;
        }
        const $tableBody = $("#asset-checklist-body");
        $tableBody.html('<tr><td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm"></div> Lade...</td></tr>');
        $.ajax({
            url: `/get_assets_for_room?room=${encodeURIComponent(roomName)}`, type: "GET",
            success: function(response) {
                App.checklist = response.success ? (response.assets || []) : [];
                if (!response.success) $tableBody.html(`<tr><td colspan="3" class="text-center text-danger">Fehler: ${response.message}</td></tr>`);
                renderChecklistTable();
            },
            error: function() {
                App.checklist = [];
                $tableBody.html('<tr><td colspan="3" class="text-center text-danger">Serverfehler.</td></tr>');
            }
        });
    }

    function runImport(withRemove) {
        App.importConfirmModal.hide();
        const $button = $("#start-import-btn");
        $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Importiere...');
        const payload = [{"Text": App.raum}, ...App.scannedItems.map(code => ({"code": code}))];
        if (withRemove) {
            const missingIds = App.missingAssets.map(asset => asset.id || asset.unid).filter(id => id);
            if (missingIds.length > 0) payload.push({"missingAssetIds": missingIds});
        }

        // GEÄNDERT: Die Logik nach dem AJAX-Aufruf
        $.ajax({
            url: "/direct_import", type: "POST", data: JSON.stringify(payload), contentType: "application/json; charset=utf-8", dataType: "json",
            success: function(response) {
                // Wenn das Backend erfolgreich war und eine URL sendet, leiten wir weiter.
                if (response.success && response.redirect_url) {
                    window.location.href = response.redirect_url;
                } else {
                    // Falls etwas schiefgeht, zeigen wir eine Fehlermeldung an.
                    alert("Ein Fehler ist aufgetreten: " + (response.message || "Unbekannter Fehler"));
                    $button.prop('disabled', false).text('Import nach TopDesk starten');
                }
            },
            error: function() {
                alert("Ein schwerwiegender Serverfehler ist aufgetreten.");
                $button.prop('disabled', false).text('Import nach TopDesk starten');
            }
        });
    }

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    const onScanSuccess = (decodedText, decodedResult) => {
        if (App.scannerState === 'PAUSED') return;
        App.scannerState = 'PAUSED';
        html5QrCode.pause();
        playBeep();
        const codeFormat = decodedResult.result.format.formatName;
        if (codeFormat === "QR_CODE") {
            let roomName = decodedText;
            try {
                const qrData = JSON.parse(decodedText);
                if (qrData && qrData.name) roomName = qrData.name;
            } catch (e) {}
            App.raum = roomName;
            $("#raumfeld").val(App.raum);
            fetchChecklist(App.raum);
        } else {
            addScannedItem(decodedText);
        }
        setTimeout(() => {
            if (html5QrCode.getState() === Html5QrcodeScannerState.PAUSED) html5QrCode.resume();
            App.scannerState = 'SCANNING';
        }, 1000);
    };

    function startCamera() {
        $("#reader").html("");
        if (html5QrCode.isScanning) return;
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (errorMessage) => {})
        .then(() => {
            App.scannerState = 'SCANNING';
            const videoElement = document.getElementById("reader").querySelector("video");
            if (videoElement && videoElement.srcObject) {
                const track = videoElement.srcObject.getVideoTracks()[0];
                if (track) {
                    const capabilities = track.getCapabilities();
                    if (capabilities.torch) { App.videoTrack = track; $("#torch-btn").show(); }
                }
            }
        }).catch((err) => { $("#reader").html(`<div class="alert alert-danger p-2"><b>Kamerafehler:</b> ${err}.</div>`); });
    }

    function stopCamera() {
        if (html5QrCode.isScanning) {
            if (App.torchOn && App.videoTrack) {
                App.videoTrack.applyConstraints({ advanced: [{ torch: false }] });
                App.torchOn = false;
            }
            html5QrCode.stop().then(() => { App.scannerState = 'STOPPED'; App.videoTrack = null; $("#torch-btn").hide(); });
        }
    }

    $(".controls").on("click", "button.start", startCamera);
    $(".controls").on("click", "button.stop", stopCamera);
    $("#torch-btn").on("click", function() {
        if (App.videoTrack) { App.torchOn = !App.torchOn; App.videoTrack.applyConstraints({ advanced: [{ torch: App.torchOn }] }); }
    });
    $("#raumfeld").on("keypress", e => { if (e.which === 13) { App.raum = $(e.target).val(); fetchChecklist(App.raum); }});
    $(".controls").on("click", "button.reset", () => {
        stopCamera();
        App.raum = ""; App.scannedItems = []; App.checklist = [];
        $("#raumfeld").val(""); renderScannedItems();
        $("#asset-checklist-body").html('<tr><td colspan="3" class="text-center text-muted">Bitte zuerst einen Raum auswählen.</td></tr>');
        $("#import-feedback").empty().hide();
    });

    $("#start-import-btn").on("click", function() {
        App.raum = $("#raumfeld").val();
        if (!App.raum) { alert("Bitte zuerst einen gültigen Raum scannen oder eingeben."); return; }
        App.missingAssets = App.checklist.filter(asset => !App.scannedItems.includes(asset?.name || 'N/A'));
        if (App.missingAssets.length === 0) {
            runImport(false);
        } else {
            $("#missing-assets-count").text(App.missingAssets.length);
            const $list = $("#missing-assets-list");
            $list.empty();
            App.missingAssets.forEach(asset => $list.append(`<li class="list-group-item list-group-item-danger">${asset.name} - ${asset['@@summary']}</li>`));
            App.importConfirmModal.show();
        }
    });

    $("#import-update-only-btn").on("click", () => runImport(false));
    $("#import-remove-missing-btn").on("click", () => runImport(true));

    renderScannedItems();
});
</script>
{% endblock content %}
