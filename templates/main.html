{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Obere Reihe für Scanner und gescannte Items -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h4>1. Raum scannen oder eingeben</h4>
            <div class="form-group mb-3">
                <input type="text" class="form-control form-control-lg" id="raumfeld" placeholder="Raum-QR-Code scannen...">
            </div>
            <h4>2. Geräte scannen</h4>
            <div id="reader" style="width: 100%; max-width: 600px; margin: auto; border: 1px solid lightgray;"></div>
            <div class="controls mt-3">
                <button class="btn btn-info start">Kamera Start</button>
                <button class="btn btn-danger stop">Kamera Stop</button>
                <button class="btn btn-warning reset">Reset</button>
            </div>
        </div>
        <div class="col-md-6">
            <h4>Gescannte Geräte</h4>
            <div id="result_strip" class="mb-3" style="max-height: 250px; overflow-y: auto;">
                <ul class="thumbnails list-group"></ul>
            </div>
            <!-- WIEDERHERGESTELLT: Der Bereich für den Import-Vorgang -->
             <div class="d-grid">
                <button id="start-import-btn" class="btn btn-success btn-lg">Import nach TopDesk starten</button>
            </div>
            <div id="import-feedback" class="mt-2"></div>
        </div>
    </div>

    <!-- Untere Reihe für die Asset-Checkliste -->
    <hr>
    <h4>Asset-Checkliste für den ausgewählten Raum</h4>
    <div id="checklist-container" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-sm table-bordered">
            <thead class="table-dark sticky-top">
                <tr>
                    <th>Asset Name</th>
                    <th>Seriennummer</th>
                    <th>Inventarnr.</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="asset-checklist-body">
                <tr>
                    <td colspan="4" class="text-center text-muted">Bitte zuerst einen Raum auswählen.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Skripte am Ende der Datei -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
// Das gesamte JavaScript ist jetzt hier integriert
$(function() {
    // Zentraler Speicher für den Zustand
    const App = {
        raum: "",
        scannedItems: [], // Enthält die Codes der gescannten Geräte
        checklist: [],    // Enthält die Asset-Objekte, die im Raum sein sollten
        scannerState: null
    };

    // --- TEIL 1: FUNKTIONEN ZUR DARSTELLUNG (VIEW) ---

    function renderScannedItems() {
        const $list = $(".thumbnails");
        $list.empty();
        if (App.scannedItems.length === 0) {
            $list.append('<li class="list-group-item text-muted">Noch keine Geräte gescannt.</li>');
            return;
        }
        App.scannedItems.forEach(code => {
            let $li = $(`
                <li class="list-group-item thumbnail-item d-flex justify-content-between align-items-center">
                    <span class="code">${code}</span>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeScan('${code}')">&times;</button>
                </li>
            `);
            $list.prepend($li);
        });
    }

    function renderChecklistTable() {
        const $tableBody = $("#asset-checklist-body");
        $tableBody.empty();
        if (App.checklist.length === 0) {
            $tableBody.append('<tr><td colspan="4" class="text-center text-muted">Für diesen Raum sind keine Assets in TopDesk hinterlegt oder der Raum wurde nicht gefunden.</td></tr>');
            return;
        }
        App.checklist.forEach(asset => {
            const assetNumber = asset?.number || 'N/A';
            const serialNumber = asset?.optionalFields?.serialNumber || 'N/A';
            const isScanned = App.scannedItems.includes(assetNumber) || (serialNumber !== 'N/A' && App.scannedItems.includes(serialNumber));
            const rowClass = isScanned ? 'table-success' : 'table-danger';
            const rowHtml = `
                <tr class="${rowClass}" data-asset-number="${assetNumber}">
                    <td>${asset?.name || 'N/A'}</td>
                    <td>${serialNumber}</td>
                    <td>${assetNumber}</td>
                    <td>${isScanned ? 'Gefunden ✔' : 'Fehlt ✖'}</td>
                </tr>
            `;
            $tableBody.append(rowHtml);
        });
    }

    // --- TEIL 2: FUNKTIONEN ZUR DATENVERÄNDERUNG (CONTROLLER) ---

    function addScannedItem(code) {
        if (code && !App.scannedItems.includes(code)) {
            App.scannedItems.push(code);
            renderScannedItems();
            renderChecklistTable();
        }
    }

    window.removeScan = function(code) {
        App.scannedItems = App.scannedItems.filter(item => item !== code);
        renderScannedItems();
        renderChecklistTable();
    };

    function fetchChecklist(roomName) {
        if (!roomName) {
            App.checklist = [];
            $("#asset-checklist-body").html('<tr><td colspan="4" class="text-center text-muted">Bitte zuerst einen Raum auswählen.</td></tr>');
            return;
        }
        const $tableBody = $("#asset-checklist-body");
        $tableBody.html('<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> Lade Asset-Liste für Raum...</td></tr>');
        $.ajax({
            url: `/get_assets_for_room?room=${encodeURIComponent(roomName)}`,
            type: "GET",
            success: function(response) {
                if (response.success) {
                    App.checklist = response.assets || [];
                } else {
                    App.checklist = [];
                    $tableBody.html(`<tr><td colspan="4" class="text-center text-danger">Fehler: ${response.message}</td></tr>`);
                }
                renderChecklistTable();
            },
            error: function() {
                App.checklist = [];
                $tableBody.html('<tr><td colspan="4" class="text-center text-danger">Serverfehler beim Laden der Asset-Liste.</td></tr>');
            }
        });
    }

    // --- TEIL 3: SCANNER-LOGIK ---
    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    const onScanSuccess = (decodedText, decodedResult) => {
        if (App.scannerState === 'PAUSED') return;
        App.scannerState = 'PAUSED';
        html5QrCode.pause();

        const codeFormat = decodedResult.result.format.formatName;

        if (codeFormat === "QR_CODE") {
            // Wenn es ein QR-Code ist, wird er IMMER als Raum behandelt.
            let roomName = decodedText;
            try {
                // Versuch, ein spezifisches .name Feld zu finden
                const qrData = JSON.parse(decodedText);
                if (qrData && qrData.name) {
                    roomName = qrData.name;
                }
            } catch (e) {
                // Wenn es kein JSON ist, wird der rohe Text als Raumname verwendet.
            }
            App.raum = roomName;
            $("#raumfeld").val(App.raum);
            fetchChecklist(App.raum);
        } else {
            // Alle anderen Formate (Code_128, etc.) werden als Geräte hinzugefügt.
            addScannedItem(decodedText);
        }

        setTimeout(() => {
            if (html5QrCode.getState() === Html5QrcodeScannerState.PAUSED) {
                html5QrCode.resume();
            }
            App.scannerState = 'SCANNING';
        }, 1000);
    };

    // --- TEIL 4: EVENT-LISTENER ---
    $(".controls").on("click", "button.start", () => {
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (e) => {});
        App.scannerState = 'SCANNING';
    });
    $(".controls").on("click", "button.stop", () => {
        if (html5QrCode.isScanning) {
            html5QrCode.stop().then(() => { App.scannerState = 'STOPPED'; });
        }
    });

    $("#raumfeld").on("keypress", function(e) {
        if (e.which === 13) {
            const newRoom = $(this).val();
            if (App.raum !== newRoom) {
                App.raum = newRoom;
                fetchChecklist(App.raum);
            }
        }
    });

    $(".controls").on("click", "button.reset", function() {
        App.raum = "";
        App.scannedItems = [];
        App.checklist = [];
        $("#raumfeld").val("");
        renderScannedItems();
        $("#asset-checklist-body").html('<tr><td colspan="4" class="text-center text-muted">Bitte zuerst einen Raum auswählen.</td></tr>');
        $("#import-feedback").empty().removeClass();
    });

    // WIEDERHERGESTELLT: Event-Listener für den Import-Button
    $("#start-import-btn").on("click", function() {
        App.raum = $("#raumfeld").val();
        if (!App.raum) {
            alert("Bitte einen Raum angeben oder scannen.");
            return;
        }
        if (App.scannedItems.length === 0) {
            alert("Keine Geräte zum Importieren gescannt.");
            return;
        }

        const $feedback = $("#import-feedback");
        const $button = $(this);
        $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Importiere...');
        $feedback.html('').removeClass().addClass('alert alert-info').text('Verarbeitung läuft...');

        const payload = [{"Text": App.raum}, ...App.scannedItems.map(code => ({"code": code}))];

        $.ajax({
            url: "/direct_import",
            type: "POST",
            data: JSON.stringify(payload),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(response) {
                let reportHtml = `<h6>${response.message}</h6>`;
                if (response.report) {
                    reportHtml += '<ul class="list-unstyled">';
                    response.report.successful?.forEach(msg => reportHtml += `<li class="text-success small">✔ ${msg}</li>`);
                    response.report.not_found?.forEach(msg => reportHtml += `<li class="text-warning small">⚠ ${msg}</li>`);
                    response.report.errors?.forEach(msg => reportHtml += `<li class="text-danger small">✖ ${msg}</li>`);
                    reportHtml += '</ul>';
                }

                if (response.success) {
                    $feedback.removeClass('alert-info').addClass('alert alert-success').html(reportHtml);
                    // Reset nach Erfolg
                    setTimeout(() => $(".controls button.reset").trigger("click"), 3000);
                } else {
                    $feedback.removeClass('alert-info').addClass('alert alert-danger').html("<strong>Fehler:</strong> " + response.message);
                }
            },
            error: function() {
                $feedback.removeClass('alert-info').addClass('alert alert-danger').text("Ein schwerwiegender Serverfehler ist aufgetreten.");
            },
            complete: function() {
                $button.prop('disabled', false).text('Import nach TopDesk starten');
            }
        });
    });

    renderScannedItems();

    // --- NEU: Kamera direkt beim Laden der Seite starten ---
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (e) => {})
        .then(() => {
            console.log("Kamera automatisch gestartet.");
            App.scannerState = 'SCANNING';
        })
        .catch(err => {
            console.error("Automatischer Kamerastart fehlgeschlagen. Möglicherweise sind keine Berechtigungen erteilt.", err);
            $("#reader").html('<div class="alert alert-warning p-2">Kamerastart fehlgeschlagen. Bitte Berechtigungen erteilen und manuell auf "Kamera Start" klicken.</div>');
        });
});
</script>
{% endblock content %}
